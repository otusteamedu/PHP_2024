# Запрос №4: Поиск 3 самых прибыльных фильмов за неделю

# Оптимизация:

Добавлены индексы на колонки, которые используются в качестве внешних ключей:

- `sessions.movie_id`
- `sales.session_id`

Добавлен индекс на колонку `date` таблицы `sales`.

## 1.000 записей

До оптимизации:

```postgresql
Subquery Scan on q_4_weekly_sales_valuable_movies  (cost=86.75..86.78 rows=3 width=45) (actual time=1.418..1.422 rows=3 loops=1)
   ->  Limit  (cost=86.75..86.75 rows=3 width=53) (actual time=1.417..1.420 rows=3 loops=1)
         ->  Sort  (cost=86.75..86.99 rows=96 width=53) (actual time=1.416..1.418 rows=3 loops=1)
               Sort Key: (sum(sales.grand_total)) DESC
               Sort Method: top-N heapsort  Memory: 25kB
               ->  HashAggregate  (cost=84.30..85.50 rows=96 width=53) (actual time=1.351..1.382 rows=88 loops=1)
                     Group Key: movies.id
                     Batches: 1  Memory Usage: 80kB
                     ->  Hash Join  (cost=62.12..83.83 rows=96 width=26) (actual time=0.492..0.740 rows=96 loops=1)
                           Hash Cond: (movies.id = sessions.movie_id)
                           ->  Seq Scan on movies  (cost=0.00..17.00 rows=1000 width=21) (actual time=0.007..0.101 rows=1000 loops=1)
                           ->  Hash  (cost=60.91..60.91 rows=96 width=13) (actual time=0.478..0.479 rows=96 loops=1)
                                 Buckets: 1024  Batches: 1  Memory Usage: 13kB
                                 ->  Hash Join  (cost=32.20..60.91 rows=96 width=13) (actual time=0.251..0.459 rows=96 loops=1)
                                       Hash Cond: (sessions.id = sales.session_id)
                                       ->  Seq Scan on sessions  (cost=0.00..19.00 rows=1000 width=16) (actual time=0.003..0.097 rows=1000 loops=1)
                                       ->  Hash  (cost=31.00..31.00 rows=96 width=13) (actual time=0.241..0.241 rows=96 loops=1)
                                             Buckets: 1024  Batches: 1  Memory Usage: 13kB
                                             ->  Seq Scan on sales  (cost=0.00..31.00 rows=96 width=13) (actual time=0.009..0.219 rows=96 loops=1)
                                                   Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
                                                   Rows Removed by Filter: 882

Planning Time: 0.786 ms
Execution Time: 1.495 ms

(23 rows)
```

После оптимизации:

```postgresql
Subquery Scan on q_4_weekly_sales_valuable_movies  (cost=72.04..72.08 rows=3 width=45) (actual time=0.790..0.796 rows=3 loops=1)
   ->  Limit  (cost=72.04..72.05 rows=3 width=53) (actual time=0.789..0.793 rows=3 loops=1)
         ->  Sort  (cost=72.04..72.28 rows=96 width=53) (actual time=0.788..0.791 rows=3 loops=1)
               Sort Key: (sum(sales.grand_total)) DESC
               Sort Method: top-N heapsort  Memory: 25kB
               ->  HashAggregate  (cost=69.60..70.80 rows=96 width=53) (actual time=0.694..0.725 rows=88 loops=1)
                     Group Key: movies.id
                     Batches: 1  Memory Usage: 80kB
                     ->  Hash Join  (cost=47.41..69.12 rows=96 width=26) (actual time=0.341..0.542 rows=96 loops=1)
                           Hash Cond: (movies.id = sessions.movie_id)
                           ->  Seq Scan on movies  (cost=0.00..17.00 rows=1000 width=21) (actual time=0.005..0.091 rows=1000 loops=1)
                           ->  Hash  (cost=46.21..46.21 rows=96 width=13) (actual time=0.327..0.330 rows=96 loops=1)
                                 Buckets: 1024  Batches: 1  Memory Usage: 13kB
                                 ->  Hash Join  (cost=17.50..46.21 rows=96 width=13) (actual time=0.096..0.309 rows=96 loops=1)
                                       Hash Cond: (sessions.id = sales.session_id)
                                       ->  Seq Scan on sessions  (cost=0.00..19.00 rows=1000 width=16) (actual time=0.003..0.104 rows=1000 loops=1)
                                       ->  Hash  (cost=16.30..16.30 rows=96 width=13) (actual time=0.084..0.085 rows=96 loops=1)
                                             Buckets: 1024  Batches: 1  Memory Usage: 13kB
                                             ->  Bitmap Heap Scan on sales  (cost=5.14..16.30 rows=96 width=13) (actual time=0.024..0.063 rows=96 loops=1)
                                                   Recheck Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))
                                                   Heap Blocks: exact=9
                                                   ->  Bitmap Index Scan on idx_sales_date  (cost=0.00..5.12 rows=96 width=0) (actual time=0.016..0.016 rows=96 loops=1)
                                                         Index Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))

Planning Time: 2.460 ms
Execution Time: 0.880 ms

(25 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала почти в 2 раза быстрее.

## 10.000 записей

До оптимизации:

```postgresql
Subquery Scan on q_4_weekly_sales_valuable_movies  (cost=906.11..906.15 rows=3 width=45) (actual time=10.202..10.209 rows=3 loops=1)
   ->  Limit  (cost=906.11..906.12 rows=3 width=53) (actual time=10.200..10.205 rows=3 loops=1)
         ->  Sort  (cost=906.11..908.59 rows=989 width=53) (actual time=10.196..10.200 rows=3 loops=1)
               Sort Key: (sum(sales.grand_total)) DESC
               Sort Method: top-N heapsort  Memory: 25kB
               ->  HashAggregate  (cost=880.97..893.33 rows=989 width=53) (actual time=9.593..9.940 rows=917 loops=1)
                     Group Key: movies.id
                     Batches: 1  Memory Usage: 577kB
                     ->  Hash Join  (cost=627.13..876.02 rows=989 width=26) (actual time=6.389..8.922 rows=989 loops=1)
                           Hash Cond: (movies.id = sessions.movie_id)
                           ->  Seq Scan on movies  (cost=0.00..164.00 rows=10000 width=21) (actual time=0.011..0.954 rows=10000 loops=1)
                           ->  Hash  (cost=614.77..614.77 rows=989 width=13) (actual time=6.364..6.367 rows=989 loops=1)
                                 Buckets: 1024  Batches: 1  Memory Usage: 52kB
                                 ->  Hash Join  (cost=309.00..614.77 rows=989 width=13) (actual time=3.519..6.119 rows=989 loops=1)
                                       Hash Cond: (sales.session_id = sessions.id)
                                       ->  Seq Scan on sales  (cost=0.00..303.17 rows=989 width=13) (actual time=0.010..2.195 rows=989 loops=1)
                                             Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
                                             Rows Removed by Filter: 8841
                                       ->  Hash  (cost=184.00..184.00 rows=10000 width=16) (actual time=3.493..3.494 rows=10000 loops=1)
                                             Buckets: 16384  Batches: 1  Memory Usage: 597kB
                                             ->  Seq Scan on sessions  (cost=0.00..184.00 rows=10000 width=16) (actual time=0.005..1.527 rows=10000 loops=1)

Planning Time: 1.362 ms
Execution Time: 10.351 ms

(23 rows)
```

После оптимизации:

```postgresql
Subquery Scan on q_4_weekly_sales_valuable_movies  (cost=905.28..905.32 rows=3 width=45) (actual time=10.027..10.036 rows=3 loops=1)
   ->  Limit  (cost=905.28..905.29 rows=3 width=53) (actual time=10.025..10.031 rows=3 loops=1)
         ->  Sort  (cost=905.28..907.75 rows=985 width=53) (actual time=10.021..10.027 rows=3 loops=1)
               Sort Key: (sum(sales.grand_total)) DESC
               Sort Method: top-N heapsort  Memory: 25kB
               ->  HashAggregate  (cost=880.24..892.55 rows=985 width=53) (actual time=9.478..9.772 rows=877 loops=1)
                     Group Key: movies.id
                     Batches: 1  Memory Usage: 577kB
                     ->  Hash Join  (cost=626.47..875.32 rows=985 width=26) (actual time=6.439..8.742 rows=985 loops=1)
                           Hash Cond: (movies.id = sessions.movie_id)
                           ->  Seq Scan on movies  (cost=0.00..164.00 rows=10000 width=21) (actual time=0.011..0.943 rows=10000 loops=1)
                           ->  Hash  (cost=614.15..614.15 rows=985 width=13) (actual time=6.411..6.415 rows=985 loops=1)
                                 Buckets: 1024  Batches: 1  Memory Usage: 52kB
                                 ->  Hash Join  (cost=309.00..614.15 rows=985 width=13) (actual time=3.446..6.062 rows=985 loops=1)
                                       Hash Cond: (sales.session_id = sessions.id)
                                       ->  Seq Scan on sales  (cost=0.00..302.57 rows=985 width=13) (actual time=0.011..2.254 rows=985 loops=1)
                                             Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
                                             Rows Removed by Filter: 8818
                                       ->  Hash  (cost=184.00..184.00 rows=10000 width=16) (actual time=3.422..3.424 rows=10000 loops=1)
                                             Buckets: 16384  Batches: 1  Memory Usage: 597kB
                                             ->  Seq Scan on sessions  (cost=0.00..184.00 rows=10000 width=16) (actual time=0.004..1.608 rows=10000 loops=1)

Planning Time: 1.017 ms
Execution Time: 10.160 ms

(23 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала немного быстрее.

## 100.000 записей

До оптимизации:

```postgresql
Subquery Scan on q_4_weekly_sales_valuable_movies  (cost=8664.44..8664.48 rows=3 width=45) (actual time=81.918..81.922 rows=3 loops=1)
   ->  Limit  (cost=8664.44..8664.45 rows=3 width=53) (actual time=81.915..81.918 rows=3 loops=1)
         ->  Sort  (cost=8664.44..8688.87 rows=9772 width=53) (actual time=81.911..81.914 rows=3 loops=1)
               Sort Key: (sum(sales.grand_total)) DESC
               Sort Method: top-N heapsort  Memory: 25kB
               ->  HashAggregate  (cost=8415.99..8538.14 rows=9772 width=53) (actual time=78.932..80.786 rows=8927 loops=1)
                     Group Key: movies.id
                     Batches: 1  Memory Usage: 4241kB
                     ->  Hash Join  (cost=6257.41..8367.13 rows=9772 width=26) (actual time=59.564..74.944 rows=9806 loops=1)
                           Hash Cond: (movies.id = sessions.movie_id)
                           ->  Seq Scan on movies  (cost=0.00..1637.00 rows=100000 width=21) (actual time=0.012..5.491 rows=100000 loops=1)
                           ->  Hash  (cost=6135.26..6135.26 rows=9772 width=13) (actual time=59.528..59.530 rows=9806 loops=1)
                                 Buckets: 16384  Batches: 1  Memory Usage: 559kB
                                 ->  Hash Join  (cost=3084.00..6135.26 rows=9772 width=13) (actual time=35.997..57.389 rows=9806 loops=1)
                                       Hash Cond: (sales.session_id = sessions.id)
                                       ->  Seq Scan on sales  (cost=0.00..3025.61 rows=9772 width=13) (actual time=0.023..12.400 rows=9806 loops=1)
                                             Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
                                             Rows Removed by Filter: 88310
                                       ->  Hash  (cost=1834.00..1834.00 rows=100000 width=16) (actual time=35.458..35.459 rows=100000 loops=1)
                                             Buckets: 131072  Batches: 1  Memory Usage: 5712kB
                                             ->  Seq Scan on sessions  (cost=0.00..1834.00 rows=100000 width=16) (actual time=0.006..12.629 rows=100000 loops=1)

Planning Time: 1.969 ms
Execution Time: 82.107 ms

(23 rows)
```

После оптимизации:

```postgresql
Subquery Scan on q_4_weekly_sales_valuable_movies  (cost=6813.17..6813.20 rows=3 width=45) (actual time=75.167..75.176 rows=3 loops=1)
   ->  Limit  (cost=6813.17..6813.17 rows=3 width=53) (actual time=75.165..75.170 rows=3 loops=1)
         ->  Sort  (cost=6813.17..6837.60 rows=9772 width=53) (actual time=75.160..75.165 rows=3 loops=1)
               Sort Key: (sum(sales.grand_total)) DESC
               Sort Method: top-N heapsort  Memory: 25kB
               ->  HashAggregate  (cost=6564.71..6686.86 rows=9772 width=53) (actual time=72.212..73.903 rows=8927 loops=1)
                     Group Key: movies.id
                     Batches: 1  Memory Usage: 4241kB
                     ->  Hash Join  (cost=4406.13..6515.85 rows=9772 width=26) (actual time=50.469..67.790 rows=9806 loops=1)
                           Hash Cond: (movies.id = sessions.movie_id)
                           ->  Seq Scan on movies  (cost=0.00..1637.00 rows=100000 width=21) (actual time=0.010..6.742 rows=100000 loops=1)
                           ->  Hash  (cost=4283.98..4283.98 rows=9772 width=13) (actual time=50.416..50.419 rows=9806 loops=1)
                                 Buckets: 16384  Batches: 1  Memory Usage: 559kB
                                 ->  Hash Join  (cost=3220.46..4283.98 rows=9772 width=13) (actual time=39.742..48.584 rows=9806 loops=1)
                                       Hash Cond: (sales.session_id = sessions.id)
                                       ->  Bitmap Heap Scan on sales  (cost=136.46..1174.33 rows=9772 width=13) (actual time=0.550..4.385 rows=9806 loops=1)
                                             Recheck Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))
                                             Heap Blocks: exact=818
                                             ->  Bitmap Index Scan on idx_sales_date  (cost=0.00..134.02 rows=9772 width=0) (actual time=0.434..0.435 rows=9806 loops=1)
                                                   Index Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))
                                       ->  Hash  (cost=1834.00..1834.00 rows=100000 width=16) (actual time=38.343..38.344 rows=100000 loops=1)
                                             Buckets: 131072  Batches: 1  Memory Usage: 5712kB
                                             ->  Seq Scan on sessions  (cost=0.00..1834.00 rows=100000 width=16) (actual time=0.013..13.586 rows=100000 loops=1)

Planning Time: 0.955 ms
Execution Time: 75.505 ms

(25 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала немного быстрее.
