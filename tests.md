# Кейсы тестирования

## Примечания и ограничения
1. Полагаю, что поля Order_number и Sum пользователь заполнять не должен. Значения полей должны быть получены при переходе пользователя со страницы фильма на страницу оплаты. Все данные у нас уже должны быть (filmId, userId для идентифицированного пользователя), по ним можно сформировать номер заказа с привязкой к пользователю, установить сумму оплаты с учетом возможной скидки и передать на страницу оплаты. И конечно тут имеется целый пласт методов, которые нужно покрыть тестами. Но заставлять Пользователя вводить номер заказа и сумму — это неправильно. Поэтому нет интеграционных тестов бэк-фронт для этих полей. 
2. Проверка соответствия номера заказа или айди фильма (заказ может возникнуть например только после оплаты, чтобы базу не засорять) и суммы должна выполняться перед оплатой, но никак не после (списание денег может производиться только если нет ошибок нигде и никаких), а метод setOrderIsPaid только делает запись в БД о факте оплаты для Order_number и возвращает true. Возможно как следствие повыситься соответсвие требованиям SOLID(S) - setOrderIsPaid теперь не проверяет соответствие номера заказа и его суммы, а только записывает в БД информацию об успешной оплате.

## Тестирование

1. **Модульные тесты**

    1. Если отсутствует хотя бы одно обязательное поле, тестируемый метод возвращает 400 с сообщением об ошибке
    2. Тесты методов проверки формата обязательных полей

        1. Card_number
            - если значение поля соответствует формату, тестируемый метод возвращает 200
            - если тип не string, тестируемый метод возвращает 400 с сообщением об ошибке
            - если длина не равна 16 символам, тестируемый метод возвращает 400 с сообщением об ошибке
            - если содержит не только цифры, тестируемый метод возвращает 400 с сообщением об ошибке

        2. Card_holder
            - если значение поля соответствует формату, тестируемый метод возвращает 200
            - если тип не string, тестируемый метод возвращает 400 с сообщением об ошибке
            - если длина поля более N символов (скорее всего есть банковское правило по длине этого поля, можно проверить),  тестируемый метод возвращает 400 с сообщением об ошибке
            - если содержит не только буквы, и более одного пробела, тестируемый метод возвращает 400 с сообщением об ошибке
            - логика подсказывает, что в имени и фамилии может быть дефис, но теоретически он может и в имени и в фамилии и не один, возможно д.б. банковское правило на сей 	счёт, оставим этот пункт в // todo

        3. Card_ expiration
            - если значение поля соответствует формату, тестируемый метод возвращает 200
            - если тип не string, тестируемый метод возвращает 400 с сообщением об ошибке
            - если не соответствует формату мм/гг, тестируемый метод возвращает 400 с сообщением об ошибке

        4. Cvv
            - если значение поля соответствует формату, тестируемый метод возвращает 200
            - если тип не string, тестируемый метод возвращает 400 с сообщением об ошибке
            - если длина не равна 3 символам, тестируемый метод возвращает 400 с сообщением об ошибке
            - если содержит не только цифры, тестируемый метод возвращает 400 с сообщением об ошибке
          
    3. Тесты методов генерации Order_number и Sum

        1. Order_number 
            - ожидаем тип string
            - ожидаем длину не более 16 символов

        2. Sum
            - ожидаем тип string
            - ожидаем длину не более разумного лимита цены услуги
            - ожидаем формат [цифры|запятая|не более двух цифр]

2. **Интеграционные тесты**

    1. **Связка фронт - бэк**
        1. Если Card_number заполнен некорректно или отсутствует, тестируемый метод выделяет поле красным, выводит пользователю соответствующее сообщение
        2. Если Card_holder заполнен некорректно или отсутствует, тестируемый метод выделяет поле красным, выводит пользователю соответствующее сообщение
        3. Если Card_expiration заполнен некорректно или отсутствует, тестируемый метод выделяет поле красным, выводит пользователю соответствующее сообщение
        4. Если Cvv заполнен некорректно или отсутствует, тестируемый метод выделяет поле красным, выводит пользователю соответствующее сообщение
      
    2. **Связка бэк - сервис А**
        1. Если данные валидированы успешно, тестируемый метод передаёт эти данные сервису А
        2. Если данные переданы, ожидаем от сервиса А 403 или 200 (мы не можем знать заранее результат проверки данных карты в банковском сервисе, даже если эти данные соответствуют формату)
        3. Если получен 403, ожидаем вместе с ним сообщение об ошибке
      
    3. **Связка сервис А - репозиторий**
        1. Если от сервиса А получен 200 (считаем, что заказ и сумма проверены до оплаты, см. примечание), тестируемый setOrderIsPaid должен вернуть true
        2. Если от сервиса А получен 403, тестируемый  setOrderIsPaid или не должен быть вызван или ожидаем от него соответствующее исключение
           
    4. **Связка репозиторий - БД**
        1. Проверить соответствие значения Sum данным прейскуранта (таблица в БД) с учётом возможных скидок
        2. В зависимости от логики обработки заказа проверить, что сделана запись в БД для Order_number и запись содержит корректную Sum
        3. Если тестируемый setOrderIsPaid вернул true, нужно сходить в БД и проверить наличие и корректность записи об оплате для Order_number и Sum
        4. Если тестируемый setOrderIsPaid вернул false, нужно сходить в БД и проверить отсутсвие записи об оплате для Order_number

3. **Системные тесты**
- Считаем, что во всех тестах получены валидные данные с фронта
    1. Если от сервиса А вернулся 403, тестируемый метод должен вернуть на фронт соответствующее сообщение (не корректные данные карты, не хватает средств и т.п.)
    2. Если от сервиса А вернулся 200, тестируемый метод должен вернуть на фронт соответствующее сообщение об успешной оплате с пожеланием приятного просмотра
    3. Если сервис А, равно как и любой другой сервис в цепочке проверки карты и списания денег недоступен, тестируемый метод должен вернуть на фронт сообщение «в настоящий момент оплата невозможна, пожалуйста повторите попытку позже»
- Возможно в каждом случае выше следовало бы проверить наличие/отсутствие записи об оплате для Order_number в базе данных

5. **Дополнительные замечания:**
    1. Работу внутренних методов необходимо тестировать на тестовой БД, чтобы не замусорить реальную БД фейковыми заказами и/или не очистить её при старте тестов
    2. При интеграционных и системных тестах, в которых задействован сервис А нужно сделать мок этого сервиса
