version: '3.9'

services:

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    volumes:
      - './frontend:/app'
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    networks:
      - app-network
  
  nginx-frontend:
    build:
      context: ./docker/nginx-frontend
      dockerfile: Dockerfile
    container_name: nginx-frontend
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - nginx-backend
    networks:
      - app-network

  backend:
    build:
      context: ./docker/php-fpm
      dockerfile: Dockerfile
    env_file: ./backend/.env
    container_name: backend
    volumes:
      - './backend:/app'
    networks:
      - app-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PHP_IDE_CONFIG: serverName=Docker

  nginx-backend:
    build:
      context: ./docker/nginx-backend
      dockerfile: Dockerfile
    container_name: nginx-backend
    ports:
      - "8080:8080"
    volumes:
      - './backend:/app'
    depends_on:
      - backend
    networks:
      - app-network

  postgres:
    image: postgres:13.3
    container_name: postgres
    env_file: ./backend/.env
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_ROOT_PASSWORD: postgres
      POSTGRES_DATABASE: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
#    volumes:
#      - ./docker/DDL:/docker-entrypoint-initdb.d
    depends_on:
      - backend
      - nginx-backend
    networks:
      - app-network

#  rabbitmq:
#    image: rabbitmq:3.9-management
#    container_name: rabbitmq
#    networks:
#      - app-network
#    ports:
#      - "${RABBITMQ_PORT}:${RABBITMQ_PORT}"
#      - "${RABBITMQ_ADMIN_PORT}:${RABBITMQ_ADMIN_PORT}"

#  php-fpm-consumer:
#    build:
#      context: ./docker/fpm-consumer
#      dockerfile: Dockerfile
#    env_file: .env
#    container_name: consumer
#    volumes:
#      - ./consumer:/data/app
#    networks:
#      - app-network
#    extra_hosts:
#      - "host.docker.internal:host-gateway"
#    #    command: php app/index.php
#    environment:
#      PHP_IDE_CONFIG: serverName=Docker
#    depends_on:
#      - rabbitmq

networks:
  app-network:
    driver: bridge
#    ipam:
#      config:
#        - subnet: 172.16.31.0/24