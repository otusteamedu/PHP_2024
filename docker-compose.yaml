version: '3.9'

services:

  #контейнер с Nginx
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    image: myapp/nginx
    container_name: webserver
    ports:
      - "80:80"
    volumes:
      - ./code/public:/data/app/public
    networks:
      - app-network

  php-fpm:
    build:
      context: ./docker/fpm
      dockerfile: Dockerfile
    env_file: .env
    container_name: php
    volumes:
      - ./code:/data/app
    networks:
      - app-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PHP_IDE_CONFIG: serverName=Docker
      INFRASTRUCTURE_PATH: "${SOURCE_INFRASTRUCTURE_PATH}"

  rabbitmq:
    image: rabbitmq:3.9-management
    container_name: rabbitmq
    networks:
      - app-network
    ports:
      - "${RABBITMQ_PORT}:${RABBITMQ_PORT}"
      - "${RABBITMQ_ADMIN_PORT}:${RABBITMQ_ADMIN_PORT}"
    environment:
      RABBITMQ_USER: "${RABBITMQ_USER}"
      RABBITMQ_PASSWORD: "${RABBITMQ_PASSWORD}"

  php-fpm-consumer:
    build:
      context: ./docker/fpm-consumer
      dockerfile: Dockerfile
    env_file: .env
    container_name: consumer
    volumes:
      - ./consumer:/data/app
    networks:
      - app-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PHP_IDE_CONFIG: serverName=Docker
      INFRASTRUCTURE_PATH: "${SOURCE_INFRASTRUCTURE_PATH}"
    depends_on:
      - rabbitmq

networks:
  app-network:
    driver: bridge