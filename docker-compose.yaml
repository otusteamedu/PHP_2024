version: '2'

services:
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: otus-nginx
    container_name: nginx
    ports:
      - "${APP_PORT}:80"
    volumes:
      - ./app:/data/mysite.local
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - phpsocket:/var/run
    restart: unless-stopped     
    depends_on:
      - php
      - postgres   
    networks:
      - otus

  php:
    build:
      context: ./php
      dockerfile: Dockerfile
    image: otus-php 
    container_name: php 
    volumes:
      - ./app:/data/mysite.local
      - ./php/zz-docker.conf:/usr/local/etc/php-fpm.d/zz-docker.conf
      - phpsocket:/var/run
    restart: unless-stopped     
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    networks:
      - otus

  postgres:
      image: postgres:16.0
      container_name: postgres
      volumes:
          - postgres:/var/lib/postgresql/data
      restart: unless-stopped
      environment:
        POSTGRES_DB: ${POSTGRES_DB}
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      ports:
          - "${POSTGRES_PORT}:5432"  
      networks:
          - otus

  pgadmin:
      container_name: pgadmin
      image: dpage/pgadmin4:7.8
      environment:
        PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
        PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
        PGADMIN_CONFIG_SERVER_MODE: ${PGADMIN_CONFIG_SERVER_MODE}
      volumes:
        - pgadmin-data:/var/lib/pgadmin
      restart: unless-stopped
      ports:
        - "${PGADMIN_PORT}:80"        
      networks:
        - otus

  redis:
    image: redis:latest
    container_name: redis
    command: ["sh", "-c", "exec redis-server --requirepass \"${REDIS_PASSWORD}\""]
    volumes:
      - ./redisdata:/data/mysite.local
    networks:
      - otus  

  memcached:
    build:
      context: ./memcached
      dockerfile: Dockerfile
    image: otus-memcached
    container_name: memcached
    restart: unless-stopped
    ports:
      - "${MEMCACHED_PORT}:11211"        
    networks:
      - otus

networks:
    otus:
        driver: bridge 

volumes:
    nginx:
    php:
    pgadmin-data:
    postgres:
    phpsocket:
