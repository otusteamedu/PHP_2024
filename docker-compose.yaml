version: '3.9'

services:

  #контейнер с Nginx
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    image: myapp/nginx
    container_name: webserver
    ports:
      - "80:80"
    volumes:
      - ./code/public:/data/app/public
    networks:
      - app-network

  php-fpm:
    build:
      context: ./docker/fpm
      dockerfile: Dockerfile
    env_file: .env
    container_name: php
    volumes:
      - ./code:/data/app
    networks:
      - app-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PHP_IDE_CONFIG: serverName=Docker
      INFRASTRUCTURE_PATH: "${SOURCE_INFRASTRUCTURE_PATH}"

  rabbitmq:
    image: rabbitmq:3.9-management
    container_name: rabbitmq
    networks:
      - app-network
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: "${RABBITMQ_DEFAULT_USER}"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_DEFAULT_PASS}"
#    volumes:
#      - ./docker/rabbitmq:/etc/rabbitmq

networks:
  app-network:
    driver: bridge