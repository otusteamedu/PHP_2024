# Другие SQL-решения

## Elasticsearch

### CRUD-операции

```json
{
    "title": "Агдам",
    "sku": "342-001",
    "category": "Портвейн",
    "price": 150,
    "volume": 0.7,
    "stock": [
        {
            "shop": "Мира",
            "stock": 30
        },
        {
            "shop": "Ленина",
            "stock": 0
        }
    ]
}
```

```json
{
    "title": "Красное вино Шардонель",
    "sku": "342-002",
    "category": "Вино",
    "price": 399,
    "volume": 0.5,
    "stock": [
        {
            "shop": "Мира",
            "stock": 10
        },
        {
            "shop": "Ленина",
            "stock": 5
        }
    ]
}
```

```json
{
    "title": "Белое вино Маркизель",
    "sku": "342-003",
    "category": "Вино",
    "price": 280,
    "volume": 0.5,
    "stock": [
        {
            "shop": "Мира",
            "stock": 0
        },
        {
            "shop": "Ленина",
            "stock": 0
        }
    ]
}
```

```json
{
    "title": "Вино красное Шатобриель",
    "sku": "342-004",
    "category": "Вино",
    "price": 1200,
    "volume": 0.7,
    "stock": [
        {
            "shop": "Мира",
            "stock": 0
        },
        {
            "shop": "Ленина",
            "stock": 1
        }
    ]
}
```

```json
{
    "doc": {
        "price": 2500
    }
}
```

### Массовое добавление документов

```bash
curl \
  --location \
  --insecure \
  --request POST 'https://localhost:9200/_bulk' \
  --header 'Authorization: Basic ZWxhc3RpYzo0MlkyWkZaVXFHeXRrenNYQTJ2Yg==' \
  --header 'Content-Type: application/json' \
  --data-binary "@bulk.json"
```

### Поиск

```json
{
    "query": {
        "match_all": {}
    }
}
```

```json
{
    "query": {
        "match": {
            "title": "красное вино"
        }
    }
}
```

```json
{
    "query": {
        "term": {
            "category": "Портвейн"
        }
    }
}
```

```json
{
    "query": {
        "term": {
            "category.keyword": "Портвейн"
        }
    }
}
```

```json
{
    "query": {
        "range": {
            "price": {
                "gte": 1200,
                "lt": 1300
            }
        }
    }
}
```

```json
{
    "query": {
        "bool": {
            "must": [
                {
                    "match": {
                        "title": "красное"
                    }
                }
            ],
            "filter": [
                {
                    "range": {
                        "price": {
                            "gte": 9950
                        }
                    }
                }
            ]
        }
    }
}
```

```json
{
    "query": {
        "bool": {
            "must": [
                {
                    "match": {
                        "title": "красное"
                    }
                }
            ],
            "filter": [
                {
                    "range": {
                        "price": {
                            "gte": 9950
                        }
                    }
                }
            ],
            "should": [
                {
                    "range": {
                        "volume": {
                            "gt": 0.99
                        }
                    }
                }
            ]
        }
    }
}
```

### Оптимизация индексов

```json
{
    "query": {
        "match_all": {}
    },
    "size": 0,
    "aggs": {
        "min_volume": {
            "min": {
                "field": "volume"
            }
        }
    }
}
```

```json
{
    "size": 0,
    "aggs": {
        "volumes": {
            "terms": {
                "field": "volume",
                "size": 10
            }
        }
    }
}
```

```json
{
    "mappings": {
        "properties": {
            "category": {
                "type": "keyword"
            },
            "price": {
                "type": "integer"
            },
            "sku": {
                "type": "keyword"
            },
            "stock": {
                "properties": {
                    "shop": {
                        "type": "keyword"
                    },
                    "stock": {
                        "type": "integer"
                    }
                }
            },
            "title": {
                "type": "text",
                "fields": {
                    "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                    }
                }
            },
            "volume": {
                "type": "float"
            }
        }
    }
}
```

### Поиск по вложенным массивам

```json
{
    "query": {
        "bool": {
            "filter": [
                {
                    "match": {
                        "stock.shop": "Мира"
                    }
                },
                {
                    "range": {
                        "stock.stock": {
                            "gte": 15
                        }
                    }
                }
            ]
        }
    }
}
```

```json
{
    "mappings": {
        "properties": {
            "category": {
                "type": "keyword"
            },
            "price": {
                "type": "integer"
            },
            "sku": {
                "type": "keyword"
            },
            "stock": {
                "type": "nested",
                "properties": {
                    "shop": {
                        "type": "keyword"
                    },
                    "stock": {
                        "type": "integer"
                    }
                }
            },
            "title": {
                "type": "text",
                "fields": {
                    "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                    }
                }
            },
            "volume": {
                "type": "float"
            }
        }
    }
}
```

```json
{
    "query": {
        "nested": {
            "path": "stock",
            "query": {
                "bool": {
                    "filter": [
                        {
                            "match": {
                                "stock.shop": "Мира"
                            }
                        },
                        {
                            "range": {
                                "stock.stock": {
                                    "gte": 15
                                }
                            }
                        }
                    ]
                }
            }
        }
    }
}
```

### Полнотекстовый поиск

```json
{
    "content": "Для создания ООО вам необохдимо пройти процедуру государственной регистрации в регистрирующем органе ФНС по месту юридического адреса."
}
```

```json
{
    "content": "Вы можете получить ответы на вопросы о регистрации ООО и ИП, воспользовавшись услугой бесплатной консультации по регистрации бизнеса."
}
```

```json
{
    "query": {
        "match": {
            "content": "ООО"
        }
    }
}
```

```json
{
    "query": {
        "match": {
            "content": "ИП"
        }
    }
}
```

```json
{
    "query": {
        "match": {
            "content": "консультация"
        }
    }
}
```

### Поддержка морфологии русского языка

```json
{
    "settings": {
        "analysis": {
            "filter": {
                "ru_stop": {
                    "type": "stop",
                    "stopwords": "_russian_"
                },
                "ru_stemmer": {
                    "type": "stemmer",
                    "language": "russian"
                }
            },
            "analyzer": {
                "my_russian": {
                    "tokenizer": "standard",
                    "filter": [
                        "lowercase",
                        "ru_stop",
                        "ru_stemmer"
                    ]
                }
            }
        }
    },
    "mappings": {
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "my_russian"
            }
        }
    }
}
```

```json
{
    "content": "Для создания ООО вам необохдимо пройти процедуру государственной регистрации в регистрирующем органе ФНС по месту юридического адреса."
}
```

```json
{
    "content": "Вы можете получить ответы на вопросы о регистрации ООО и ИП, воспользовавшись услугой бесплатной консультации по регистрации бизнеса."
}
```

```json
{
    "query": {
        "match": {
            "content": "консультация"
        }
    }
}
```

### Работа с опечатками

```json
{
    "query": {
        "match": {
            "content": "кансультация"
        }
    }
}
```

```json
{
    "query": {
        "match": {
            "content": {
                "query": "кансультация",
                "fuzziness": "auto"
            }
        }
    }
}
```

## Ссылка на опрос

```
https://otus.ru/polls/83096/
```
