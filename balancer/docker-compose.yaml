version: '3'

services:
  nginx_proxy:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx_proxy/hosts/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - app-network
    depends_on:
      - nginx1
      - nginx2

  nginx1:
    image: nginx:latest
    volumes:
      - ./code:/app
      - ./nginx/hosts/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - app-network
    depends_on:
      - app1
      - app2

  nginx2:
    image: nginx:latest
    volumes:
      - ./code:/app
      - ./nginx/hosts/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - app-network
    depends_on:
      - app1
      - app2

  app1:
    build:
      dockerfile: fpm/Dockerfile
    volumes:
      - ./code:/app
    working_dir: /app
    networks:
      - app-network

  app2:
    build:
      dockerfile: fpm/Dockerfile
    volumes:
      - ./code:/app
    working_dir: /app
    networks:
      - app-network

  memcached:
    image: memcached:latest
    networks:
      - app-network

networks:
  app-network:
    driver: bridge