# Запрос №2: Подсчёт проданных билетов за неделю

# Оптимизация:

Добавлен индекс на колонку `date` таблицы `sales`.

## 1.000 записей

До оптимизации:

```postgresql
Aggregate  (cost=31.24..31.25 rows=1 width=8) (actual time=0.322..0.324 rows=1 loops=1)
   ->  Seq Scan on sales  (cost=0.00..31.00 rows=96 width=8) (actual time=0.023..0.299 rows=96 loops=1)
         Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
         Rows Removed by Filter: 882

Planning Time: 1.375 ms
Execution Time: 0.380 ms

(6 rows)
```

После оптимизации:

```postgresql
Aggregate  (cost=16.54..16.55 rows=1 width=8) (actual time=0.197..0.199 rows=1 loops=1)
   ->  Bitmap Heap Scan on sales  (cost=5.14..16.30 rows=96 width=8) (actual time=0.102..0.174 rows=96 loops=1)
         Recheck Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))
         Heap Blocks: exact=9
         ->  Bitmap Index Scan on idx_sales_date  (cost=0.00..5.12 rows=96 width=0) (actual time=0.078..0.078 rows=96 loops=1)
               Index Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))

Planning Time: 1.108 ms
Execution Time: 0.306 ms

(8 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала немного быстрее.

## 10.000 записей

До оптимизации:

```postgresql
Aggregate  (cost=305.65..305.66 rows=1 width=8) (actual time=2.137..2.138 rows=1 loops=1)
   ->  Seq Scan on sales  (cost=0.00..303.17 rows=989 width=8) (actual time=0.019..2.058 rows=989 loops=1)
         Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
         Rows Removed by Filter: 8841

Planning Time: 0.523 ms
Execution Time: 2.188 ms

(6 rows)
```

После оптимизации:

```postgresql
Aggregate  (cost=305.03..305.04 rows=1 width=8) (actual time=2.269..2.270 rows=1 loops=1)
   ->  Seq Scan on sales  (cost=0.00..302.57 rows=985 width=8) (actual time=0.023..2.185 rows=985 loops=1)
         Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
         Rows Removed by Filter: 8818

Planning Time: 0.642 ms
Execution Time: 2.334 ms

(6 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала немного медленней.

## 100.000 записей

До оптимизации:

```postgresql
Aggregate  (cost=3050.04..3050.05 rows=1 width=8) (actual time=23.442..23.444 rows=1 loops=1)
   ->  Seq Scan on sales  (cost=0.00..3025.61 rows=9772 width=8) (actual time=0.023..22.572 rows=9806 loops=1)
         Filter: ((date <= now()) AND (date >= (now() - '6 days'::interval)))
         Rows Removed by Filter: 88310

Planning Time: 1.280 ms
Execution Time: 23.543 ms

(6 rows)
```

После оптимизации:

```postgresql
Aggregate  (cost=1198.76..1198.77 rows=1 width=8) (actual time=11.138..11.142 rows=1 loops=1)
   ->  Bitmap Heap Scan on sales  (cost=136.46..1174.33 rows=9772 width=8) (actual time=1.661..10.032 rows=9806 loops=1)
         Recheck Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))
         Heap Blocks: exact=818
         ->  Bitmap Index Scan on idx_sales_date  (cost=0.00..134.02 rows=9772 width=0) (actual time=1.420..1.421 rows=9806 loops=1)
               Index Cond: ((date >= (now() - '6 days'::interval)) AND (date <= now()))

Planning Time: 1.536 ms
Execution Time: 11.248 ms

(8 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала в 2 раза быстрее.
