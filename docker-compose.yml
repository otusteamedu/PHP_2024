version: '3.8'

services:
  nginx-balancer:
    image: nginx:1.25.3-alpine
    container_name: ${CONTAINER_NAME_NGINX_BALANCER}
    ports:
      - "${LOCAL_PORT_NGINX_BALANCER}:${CONTAINER_PORT_NGINX_BALANCER}"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/balancer.conf:/etc/nginx/conf.d/balancer.conf
      - ./var/nginx-balancer/logs:/var/log/nginx
    networks:
      - otus-network

  nginx1:
    image: nginx:1.25.3-alpine
    container_name: ${CONTAINER_NAME_NGINX_1}
    volumes:
      - ./app:/app
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./var/nginx1/logs:/var/log/nginx
    depends_on:
      - php-fpm1
      - php-fpm2
    networks:
      - otus-network

  nginx2:
    image: nginx:1.25.3-alpine
    container_name: ${CONTAINER_NAME_NGINX_2}
    volumes:
      - ./app:/app
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./var/nginx2/logs:/var/log/nginx
    depends_on:
      - php-fpm1
      - php-fpm2
    networks:
      - otus-network

  php-fpm1:
    build: php-fpm
    container_name: ${CONTAINER_NAME_PHP_FPM_1}
    volumes:
      - ./app:/app
      - ./php-fpm/conf.d/docker-php-ext-xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./php-fpm/php.ini:/usr/local/etc/php/php.ini
      - ./var/php-fpm1/logs:/var/logs/php
    env_file: .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - otus-network

  php-fpm2:
    build: php-fpm
    container_name: ${CONTAINER_NAME_PHP_FPM_2}
    volumes:
      - ./app:/app
      - ./php-fpm/conf.d/docker-php-ext-xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./php-fpm/php.ini:/usr/local/etc/php/php.ini
      - ./var/php-fpm2/logs:/var/logs/php
    env_file: .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - otus-network

networks:
  otus-network:
    driver: bridge