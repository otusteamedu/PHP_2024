version: '3.8'

networks:
  app_network:
    name: ${APP_NAME}_network

x-common: &app
  build:
    context: .
    dockerfile: ./docker/php/Dockerfile
  env_file: .env
  volumes:
    - .:/var/www/app
  depends_on:
    rabbitmq:
      condition: service_healthy
  networks:
    - app_network

services:
  nginx:
    image: nginx:latest
    container_name: ${APP_NAME}_nginx
    ports:
      - "${APP_PORT}:80"
    volumes:
      - .:/var/www/app
      - ./docker/nginx/conf/app.conf:/etc/nginx/conf.d/app.conf
    depends_on:
      - php
    networks:
      - app_network

  php:
    <<: *app
    container_name: ${APP_NAME}_php
    ports:
      - "9000:9000"
    depends_on:
      composer:
        condition: service_completed_successfully

  request_process_worker:
    <<: *app
    container_name: ${APP_NAME}_request_process_worker
    command: ["sh", "-c", "php command/commands.php app:request:process"]
    depends_on:
      composer:
        condition: service_completed_successfully
      postgres:
        condition: service_started

  migration_worker:
    <<: *app
    container_name: ${APP_NAME}_migration_worker
    command: [ "sh", "-c", "php migration/migrations.php" ]
    depends_on:
      composer:
        condition: service_completed_successfully
      postgres:
        condition: service_started

  composer:
    <<: *app
    container_name: ${APP_NAME}_composer
    command: [ "sh", "-c", "composer install" ]

  postgres:
    image: postgres:latest
    container_name: ${APP_NAME}_postgres
    ports:
      - "${DB_PORT}:5432"
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - ./docker/postgres/data:/var/lib/postgresql/data:rw
    networks:
      - app_network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ${APP_NAME}_rabbitmq
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "15672:15672"
    volumes:
      - ./docker/rabbitmq/data/:/var/lib/rabbitmq/
      - ./docker/rabbitmq/log/:/var/log/rabbitmq
    networks:
      - app_network
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 30s
      timeout: 10s
      retries: 5