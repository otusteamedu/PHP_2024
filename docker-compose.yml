services:
#https://hub.docker.com/_/redis
  redis:
    image: redis:7.2-alpine
    container_name: otus-php--redis
    volumes:
      - ./data/redis:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - 6379:6379
    networks:
      - otus-php-network
#https://hub.docker.com/r/redis/redisinsight
  redis-insight:
    image: redis/redisinsight:latest
    container_name: otus-php--redisinsight
#    restart: always
    ports:
      - "5540:5540"
      - "8001:8001"
    volumes:
    - ./data/redisinsight:/data
    networks:
      - otus-php-network
  php-cli:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
      args:
        ELASTIC_HOST_ARG: ${ELASTIC_HOST}
        ELASTIC_PASSWORD_ARG: ${ELASTIC_PASSWORD}
    image: irayu/php-cli
    container_name: otus-php--php
    environment:
      - ELASTIC_HOST=${ELASTIC_HOST}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USER=${REDIS_USER}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - ./code:/code
      - ./logs/php:/var/log/php
    stdin_open: true
    tty: true
    networks:
      - otus-php-network
#    depends_on:
#      es02:
#        condition: service_healthy
#  es02:
#    image: elasticsearch:8.12.2
#    container_name: otus-php--elasticsearch
#    networks:
#      - otus-php-network
#    volumes:
#      - ./data/elastic/data:/usr/share/elasticsearch/data
#    environment:
#      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
#      - ELASTIC_HOST=${ELASTIC_HOST}
#      - discovery.type=single-node
#      - xpack.security.enabled=false
#      - xpack.security.enrollment.enabled=false
#      - node.name=es02
#    ports:
#      - "9200:9200"
#      - "9300:9300"
#    expose:
#      - 9200
#    command:
#      - elasticsearch
#    healthcheck:
#      test: curl -XGET http://es02:9200/_cat/health  || exit 1
#      interval: 30s
#      timeout: 30s
#      retries: 90
networks:
  otus-php-network:
    driver: bridge
