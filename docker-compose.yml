version: '3.8'

networks:
  app_network:
    name: ${APP_NAME}_network

x-common: &app
  build:
    context: .
    dockerfile: ./docker/php/Dockerfile
  env_file: .env
  volumes:
    - .:/var/www/app
  depends_on:
    rabbitmq:
      condition: service_healthy
  networks:
    - app_network

services:

  nginx:
    image: nginx:latest
    container_name: ${APP_NAME}_nginx
    ports:
      - "${APP_PORT}:80"
    volumes:
      - .:/var/www/app
      - ./docker/nginx/app.conf:/etc/nginx/conf.d/app.conf
    depends_on:
      - php
    networks:
      - app_network

  php:
    <<: *app
    container_name: ${APP_NAME}_php
    ports:
      - "9000:9000"

  report_finance_make_worker:
    <<: *app
    container_name: ${APP_NAME}_report_finance_make_worker
    command: ["sh", "-c", "php bin/console app:report:finance:make"]

  report_finance_send_worker:
    <<: *app
    container_name: ${APP_NAME}_report_finance_send_worker
    command: ["sh", "-c", "php bin/console app:report:finance:send"]

  composer:
    <<: *app
    container_name: ${APP_NAME}_composer
    command: [ "sh", "-c", "composer install" ]

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ${APP_NAME}_rabbitmq
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "15672:15672"
    volumes:
      - ./docker/rabbitmq/data/:/var/lib/rabbitmq/
      - ./docker/rabbitmq/log/:/var/log/rabbitmq
    networks:
      - app_network
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 30s
      timeout: 10s
      retries: 5