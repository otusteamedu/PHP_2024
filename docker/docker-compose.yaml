version: "3.3"

services:
  nginx_balancer:
    container_name: hw5_nginx_balancer
    image: nginx:latest
    ports:
      - "${NGINX_PORT_OUT}:${NGINX_PORT_IN}"
    volumes:
      - ./nginx_balancer/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx_balancer/logs:/var/log/nginx
    networks:
      - backend
    depends_on:
      - nginx_instance1
      - nginx_instance2
      - nginx_instance3

  nginx_instance1:
    container_name: hw5_nginx_instance1
    image: nginx:latest
    volumes:
      - ./nginx_instance/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx_instance/logs:/var/log/nginx
      - ./../www:/www/public_html
    networks:
      - backend
    depends_on:
      - php-fpm
      - mysql

  nginx_instance2:
    container_name: hw5_nginx_instance2
    image: nginx:latest
    volumes:
      - ./nginx_instance/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx_instance/logs:/var/log/nginx
      - ./../www:/www/public_html
    networks:
      - backend
    depends_on:
      - php-fpm
      - mysql

  nginx_instance3:
    container_name: hw5_nginx_instance3
    image: nginx:latest
    volumes:
      - ./nginx_instance/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx_instance/logs:/var/log/nginx
      - ./../www:/www/public_html
    networks:
      - backend
    depends_on:
      - php-fpm
      - mysql

  mysql:
    container_name: hw5_mysql
    image: mysql:latest
    volumes:
      - ./mysql/data:/var/lib/mysql
    ports:
      - "${MYSQL_PORT_OUT}:${MYSQL_PORT_IN}"
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    networks:
      - backend

  php-fpm:
    container_name: hw5_php-fpm
    build:
      context: ./php
      dockerfile: ./php.dockerfile
    volumes:
      - ./../www:/www/public_html
    env_file:
      - .env
    networks:
      - backend
    depends_on:
      - mysql

networks:
  backend:
    driver: bridge