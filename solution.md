**Хранение данных**

Храним данные в `sorted set`. Ключ `airplane:events`.

Данные о событии формируем по такому шаблону: `<sources_priority>::<event_name>::<payload>`.
`sources_priority` представляет собой число, двоичное представление которого формируется по следующему шаблону: `1<5 бит под источники><16 бит под priority>`.

Старший бит - всегда 1, для фиксации размера числа.
`<5 бит под источники>`: каждый разряд закреплен за определенным событием. Если стоит 1, значит, это событие характеризуется этим источник, если 0, - то нет.

Биты закреплены за источниками в таком порядке (от старшего разряда к младшему):

- бортовое оборудование
- тормозная система
- шасси
- силовая установка
- планер

При этом, в связи с выбранным подходом к поиску данных, требуется обеспечить все возможные сочетания источников конкретного события, поэтому для одного события в `sorted set` будет добавлено столько `member`, сколько сочетаний потребуется:

- для одного источника - 1,
- для двух - 3,
- для трёх - 7.

<u>Пример</u>

```
event1 = [
'priority' => 10000,
'source' => ['планер'],
'payload' => '{id:141}',
];
```

будет храниться в виде одной записи:

- `'1000010010011100010000::event1::{id:141}'`

```
event2 = [
'priority' => 400,
'source' => ['шасси', 'планер'],
'payload' => '{id:1810,severity:"Bug"}',
];
```

будет храниться в виде трёх записей:

- `'1001010000000110010000::event2::{id:1810,severity:"Bug"}'`
- `'1001000000000110010000::event2::{id:1810,severity:"Bug"}'`
- `'1000010000000110010000::event2::{id:1810,severity:"Bug"}'`

```
event3 = [
'priority' => 1500,
'source' => ['бортовое оборудование', 'планер', 'шасси'],
'payload' => '{id:555}',
];
```

будет храниться в виде семи записей:

- `'1101010000010111011100::event3::{id:555}'`
- `'1101000000010111011100::event3::{id:555}'`
- `'1000010000010111011100::event3::{id:555}'`
- `'1001010000010111011100::event3::{id:555}'`
- `'1100010000010111011100::event3::{id:555}'`
- `'1001000000010111011100::event3::{id:555}'`
- `'1100000000010111011100::event3::{id:555}'`

Хранение информации об источниках и приоритете в начале самого `member` позволяет извлечь нужный нам диапазон, используя лексикографическую сортировку, поэтому в значение `score` записываем `0`.

<u>Примеры добавления событий:</u>

```bash
ZADD airplane:events 0 '1000010010011100010000::event1::{id:141}'
ZADD airplane:events 0 '1001010000000110010000::event2::{id:1810,severity:"Bug"}' 0 '1001000000000110010000::event2::{id:1810,severity:"Bug"}' 0 '1000010000000110010000::event2::{id:1810,severity:"Bug"}'
ZADD airplane:events 0 '1101010000010111011100::event3::{id:555}' 0 '1101000000010111011100::event3::{id:555}' 0 '1000010000010111011100::event3::{id:555}' 0 '1001010000010111011100::event3::{id:555}' 0 '1100010000010111011100::event3::{id:555}' 0 '1001000000010111011100::event3::{id:555}' 0 '1100000000010111011100::event3::{id:555}'
```

**Получение данных**

1. Получаем от пользователя названия источников.
2. Формируем два числа на основании источников - `<sources_priority>` часть `member`:

   1. В первом единицами заполняем те позиции битов, которые соответствуют полученным источникам, а остальные 16 бит - это двоичное представление максимального значения приоритета - 50000, то есть `1100001101010000`.
   2. Во втором делаем то же самое, только младшие 16 бит заполняем нулями.

   Первое число будет началом искомого интервала, второе - окончанием.

3. Используем команду

```bash
ZRANGE key start stop [BYSCORE | BYLEX] [REV] [LIMIT offset count] [WITHSCORES]
```

, где:

- `key` - `airplane:events`,
- `start` - первое сформированное число,
- `stop` - второе сформированное число,
- `BYLEX` - используем для лексикографической сортировки,
- `REV` - используем для сортировки приоритета по убыванию.

4. При необходимости делаем постообработку полученных данных, используя разделитель `::`, чтобы извлечь имя события и его `payload`.

<u>Например:</u>

- Поиск по источнику `планер`:

```bash
ZRANGE airplane:events [1000011100001101010000 [1000010000000000000000 BYLEX REV
1) "1000010010011100010000::event1::{id:141}"
2) "1000010000010111011100::event3::{id:555}"
3) "1000010000000110010000::event2::{id:1810,severity:\"Bug\"}"
```

- Поиск по источникам `планер`, `шасси`:

```bash
ZRANGE airplane:events [1001011100001101010000 [1001010000000000000000 BYLEX REV
1) "1001010000010111011100::event3::{id:555}"
2) "1001010000000110010000::event2::{id:1810,severity:\"Bug\"}"
```

- Поиск по источникам `планер`, `шасси`, `бортовое оборудование`:

```bash
ZRANGE airplane:events [1101011100001101010000 [1101010000000000000000 BYLEX REV
1) "1101010000010111011100::event3::{id:555}"
```

- Поиск по источникам `планер`, `шасси`, `тормозная система`:

```bash
ZRANGE airplane:events [1011011100001101010000 [1011010000000000000000 BYLEX REV
(empty array)
```
