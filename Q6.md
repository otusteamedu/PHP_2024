# Запрос №6: Вывести диапазон минимальной и максимальной цены за билет на конкретный сеанс

## Оптимизация 

Добавлены индексы на колонки, которые используются в качестве внешних ключей:

- `sessions.hall_id`
- `hall_seats.hall_id`
- `sessions.movie_id`

Добавлен индекс на колонку `price` таблицы `hall_seats`.

## 1.000 записей

До оптимизации:

```postgresql
Subquery Scan on q_6_min_max_session_price  (cost=19.55..20.21 rows=33 width=77) (actual time=0.068..0.072 rows=0 loops=1)
   ->  HashAggregate  (cost=19.55..19.88 rows=33 width=85) (actual time=0.066..0.069 rows=0 loops=1)
         Group Key: movies.id
         Batches: 1  Memory Usage: 24kB
         ->  Hash Join  (cost=16.61..19.30 rows=33 width=26) (actual time=0.060..0.062 rows=0 loops=1)
               Hash Cond: (hall_seats.hall_id = sessions.hall_id)
               ->  Seq Scan on hall_seats  (cost=0.00..1.99 rows=99 width=7) (actual time=0.020..0.020 rows=1 loops=1)
               ->  Hash  (cost=16.60..16.60 rows=1 width=23) (actual time=0.025..0.027 rows=0 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 8kB
                     ->  Nested Loop  (cost=0.55..16.60 rows=1 width=23) (actual time=0.024..0.024 rows=0 loops=1)
                           ->  Index Scan using sessions_pkey on sessions  (cost=0.28..8.29 rows=1 width=10) (actual time=0.022..0.022 rows=0 loops=1)
                                 Index Cond: (id = 2001)
                           ->  Index Scan using movies_pkey on movies  (cost=0.28..8.29 rows=1 width=21) (never executed)
                                 Index Cond: (id = sessions.movie_id)

Planning Time: 0.826 ms
Execution Time: 0.222 ms

(16 rows)
```

После оптимизации:

```postgresql
Subquery Scan on q_6_min_max_session_price  (cost=19.55..20.21 rows=33 width=77) (actual time=0.066..0.070 rows=0 loops=1)
   ->  HashAggregate  (cost=19.55..19.88 rows=33 width=85) (actual time=0.064..0.066 rows=0 loops=1)
         Group Key: movies.id
         Batches: 1  Memory Usage: 24kB
         ->  Hash Join  (cost=16.61..19.30 rows=33 width=26) (actual time=0.057..0.059 rows=0 loops=1)
               Hash Cond: (hall_seats.hall_id = sessions.hall_id)
               ->  Seq Scan on hall_seats  (cost=0.00..1.99 rows=99 width=7) (actual time=0.016..0.017 rows=1 loops=1)
               ->  Hash  (cost=16.60..16.60 rows=1 width=23) (actual time=0.025..0.026 rows=0 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 8kB
                     ->  Nested Loop  (cost=0.55..16.60 rows=1 width=23) (actual time=0.024..0.024 rows=0 loops=1)
                           ->  Index Scan using sessions_pkey on sessions  (cost=0.28..8.29 rows=1 width=10) (actual time=0.022..0.022 rows=0 loops=1)
                                 Index Cond: (id = 2001)
                           ->  Index Scan using movies_pkey on movies  (cost=0.28..8.29 rows=1 width=21) (never executed)
                                 Index Cond: (id = sessions.movie_id)

Planning Time: 1.050 ms
Execution Time: 0.215 ms

(16 rows)
```

Комментарий:

"Стоимость" запроса не изменилась, скорость ответа стала немного быстрее.

## 10.000 записей

До оптимизации:

```postgresql
Subquery Scan on q_6_min_max_session_price  (cost=19.56..20.22 rows=33 width=77) (actual time=0.177..0.183 rows=1 loops=1)
   ->  HashAggregate  (cost=19.56..19.89 rows=33 width=85) (actual time=0.175..0.179 rows=1 loops=1)
         Group Key: movies.id
         Batches: 1  Memory Usage: 24kB
         ->  Hash Join  (cost=16.62..19.31 rows=33 width=26) (actual time=0.121..0.144 rows=27 loops=1)
               Hash Cond: (hall_seats.hall_id = sessions.hall_id)
               ->  Seq Scan on hall_seats  (cost=0.00..1.99 rows=99 width=7) (actual time=0.016..0.024 rows=99 loops=1)
               ->  Hash  (cost=16.61..16.61 rows=1 width=23) (actual time=0.069..0.070 rows=1 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 9kB
                     ->  Nested Loop  (cost=0.57..16.61 rows=1 width=23) (actual time=0.053..0.056 rows=1 loops=1)
                           ->  Index Scan using sessions_pkey on sessions  (cost=0.29..8.30 rows=1 width=10) (actual time=0.023..0.026 rows=1 loops=1)
                                 Index Cond: (id = 2001)
                           ->  Index Scan using movies_pkey on movies  (cost=0.29..8.30 rows=1 width=21) (actual time=0.016..0.016 rows=1 loops=1)
                                 Index Cond: (id = sessions.movie_id)

Planning Time: 1.133 ms
Execution Time: 0.322 ms

(16 rows)
```

После оптимизации:

```postgresql
Subquery Scan on q_6_min_max_session_price  (cost=19.56..20.22 rows=33 width=77) (actual time=0.089..0.092 rows=1 loops=1)
   ->  HashAggregate  (cost=19.56..19.89 rows=33 width=85) (actual time=0.088..0.090 rows=1 loops=1)
         Group Key: movies.id
         Batches: 1  Memory Usage: 24kB
         ->  Hash Join  (cost=16.62..19.31 rows=33 width=26) (actual time=0.050..0.071 rows=27 loops=1)
               Hash Cond: (hall_seats.hall_id = sessions.hall_id)
               ->  Seq Scan on hall_seats  (cost=0.00..1.99 rows=99 width=7) (actual time=0.008..0.016 rows=99 loops=1)
               ->  Hash  (cost=16.61..16.61 rows=1 width=23) (actual time=0.028..0.029 rows=1 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 9kB
                     ->  Nested Loop  (cost=0.57..16.61 rows=1 width=23) (actual time=0.023..0.024 rows=1 loops=1)
                           ->  Index Scan using sessions_pkey on sessions  (cost=0.29..8.30 rows=1 width=10) (actual time=0.010..0.010 rows=1 loops=1)
                                 Index Cond: (id = 2001)
                           ->  Index Scan using movies_pkey on movies  (cost=0.29..8.30 rows=1 width=21) (actual time=0.006..0.007 rows=1 loops=1)
                                 Index Cond: (id = sessions.movie_id)

Planning Time: 1.168 ms
Execution Time: 0.164 ms

(16 rows)
```

Комментарий:

"Стоимость" запроса не изменилась, скорость ответа стала немного быстрее.

## 100.000 записей

До оптимизации:

```postgresql
Subquery Scan on q_6_min_max_session_price  (cost=19.57..20.23 rows=33 width=77) (actual time=0.246..0.251 rows=1 loops=1)
   ->  HashAggregate  (cost=19.57..19.90 rows=33 width=85) (actual time=0.244..0.248 rows=1 loops=1)
         Group Key: movies.id
         Batches: 1  Memory Usage: 24kB
         ->  Hash Join  (cost=16.63..19.32 rows=33 width=26) (actual time=0.193..0.217 rows=18 loops=1)
               Hash Cond: (hall_seats.hall_id = sessions.hall_id)
               ->  Seq Scan on hall_seats  (cost=0.00..1.99 rows=99 width=7) (actual time=0.015..0.024 rows=99 loops=1)
               ->  Hash  (cost=16.62..16.62 rows=1 width=23) (actual time=0.155..0.156 rows=1 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 9kB
                     ->  Nested Loop  (cost=0.58..16.62 rows=1 width=23) (actual time=0.059..0.060 rows=1 loops=1)
                           ->  Index Scan using sessions_pkey on sessions  (cost=0.29..8.31 rows=1 width=10) (actual time=0.027..0.028 rows=1 loops=1)
                                 Index Cond: (id = 2001)
                           ->  Index Scan using movies_pkey on movies  (cost=0.29..8.31 rows=1 width=21) (actual time=0.018..0.018 rows=1 loops=1)
                                 Index Cond: (id = sessions.movie_id)

Planning Time: 0.924 ms
Execution Time: 0.412 ms

(16 rows)
```

После оптимизации:

```postgresql
Subquery Scan on q_6_min_max_session_price  (cost=19.57..20.23 rows=33 width=77) (actual time=0.151..0.153 rows=1 loops=1)
   ->  HashAggregate  (cost=19.57..19.90 rows=33 width=85) (actual time=0.140..0.142 rows=1 loops=1)
         Group Key: movies.id
         Batches: 1  Memory Usage: 24kB
         ->  Hash Join  (cost=16.63..19.32 rows=33 width=26) (actual time=0.089..0.120 rows=18 loops=1)
               Hash Cond: (hall_seats.hall_id = sessions.hall_id)
               ->  Seq Scan on hall_seats  (cost=0.00..1.99 rows=99 width=7) (actual time=0.016..0.032 rows=99 loops=1)
               ->  Hash  (cost=16.62..16.62 rows=1 width=23) (actual time=0.052..0.053 rows=1 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 9kB
                     ->  Nested Loop  (cost=0.58..16.62 rows=1 width=23) (actual time=0.043..0.044 rows=1 loops=1)
                           ->  Index Scan using sessions_pkey on sessions  (cost=0.29..8.31 rows=1 width=10) (actual time=0.018..0.018 rows=1 loops=1)
                                 Index Cond: (id = 2001)
                           ->  Index Scan using movies_pkey on movies  (cost=0.29..8.31 rows=1 width=21) (actual time=0.013..0.013 rows=1 loops=1)
                                 Index Cond: (id = sessions.movie_id)

Planning Time: 1.257 ms
Execution Time: 0.344 ms

(16 rows)
```

Комментарий:

"Стоимость" запроса не изменилась, скорость ответа стала немного быстрее.
