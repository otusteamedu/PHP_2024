# Запрос №3: Формирование афиши (фильмы, которые показывают сегодня)

# Оптимизация:

Добавлены индексы на колонки, которые используются в качестве внешних ключей:

- `sessions.movie_id`
- `sessions.hall_id`

Добавлен индекс на колонку `date_start` таблицы `sessions`.

## 1.000 записей

До оптимизации:

```postgresql
Sort  (cost=69.60..69.85 rows=100 width=545) (actual time=0.789..0.798 rows=100 loops=1)
   Sort Key: sessions.date_start
   Sort Method: quicksort  Memory: 32kB
   ->  Nested Loop  (cost=29.66..66.28 rows=100 width=545) (actual time=0.391..0.751 rows=100 loops=1)
         ->  Hash Join  (cost=29.50..61.26 rows=100 width=31) (actual time=0.367..0.676 rows=100 loops=1)
               Hash Cond: (sessions.movie_id = movies.id)
               ->  Seq Scan on sessions  (cost=0.00..31.50 rows=100 width=26) (actual time=0.017..0.298 rows=100 loops=1)
                     Filter: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
                     Rows Removed by Filter: 900
               ->  Hash  (cost=17.00..17.00 rows=1000 width=21) (actual time=0.333..0.334 rows=1000 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 63kB
                     ->  Seq Scan on movies  (cost=0.00..17.00 rows=1000 width=21) (actual time=0.007..0.140 rows=1000 loops=1)
         ->  Memoize  (cost=0.15..0.65 rows=1 width=518) (actual time=0.000..0.000 rows=1 loops=100)
               Cache Key: sessions.hall_id
               Cache Mode: logical
               Hits: 97  Misses: 3  Evictions: 0  Overflows: 0  Memory Usage: 1kB
               ->  Index Scan using halls_pkey on halls  (cost=0.14..0.64 rows=1 width=518) (actual time=0.005..0.005 rows=1 loops=3)
                     Index Cond: (id = sessions.hall_id)

Planning Time: 0.761 ms
Execution Time: 0.916 ms

(20 rows)
```

После оптимизации:

```postgresql
Sort  (cost=50.70..50.95 rows=100 width=31) (actual time=2.527..2.536 rows=100 loops=1)
   Sort Key: sessions.date_start
   Sort Method: quicksort  Memory: 32kB
   ->  Hash Join  (cost=18.75..47.38 rows=100 width=31) (actual time=2.247..2.474 rows=100 loops=1)
         Hash Cond: (sessions.hall_id = halls.id)
         ->  Hash Join  (cost=17.68..45.68 rows=100 width=31) (actual time=0.223..0.429 rows=100 loops=1)
               Hash Cond: (movies.id = sessions.movie_id)
               ->  Seq Scan on movies  (cost=0.00..17.00 rows=1000 width=21) (actual time=0.016..0.108 rows=1000 loops=1)
               ->  Hash  (cost=16.43..16.43 rows=100 width=26) (actual time=0.180..0.180 rows=100 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 14kB
                     ->  Bitmap Heap Scan on sessions  (cost=5.18..16.43 rows=100 width=26) (actual time=0.062..0.150 rows=100 loops=1)
                           Recheck Cond: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
                           Heap Blocks: exact=9
                           ->  Bitmap Index Scan on idx_sessions_date_start  (cost=0.00..5.16 rows=100 width=0) (actual time=0.044..0.044 rows=100 loops=1)
                                 Index Cond: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
         ->  Hash  (cost=1.03..1.03 rows=3 width=4) (actual time=2.008..2.009 rows=3 loops=1)
               Buckets: 1024  Batches: 1  Memory Usage: 9kB
               ->  Seq Scan on halls  (cost=0.00..1.03 rows=3 width=4) (actual time=0.013..0.018 rows=3 loops=1)

Planning Time: 5.828 ms
Execution Time: 2.687 ms

(20 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала медленней. 

## 10.000 записей

До оптимизации:

```postgresql
Sort  (cost=666.31..668.81 rows=1000 width=545) (actual time=11.063..11.156 rows=1000 loops=1)
   Sort Key: sessions.date_start
   Sort Method: quicksort  Memory: 97kB
   ->  Hash Join  (cost=302.15..616.48 rows=1000 width=545) (actual time=5.235..10.655 rows=1000 loops=1)
         Hash Cond: (sessions.hall_id = halls.id)
         ->  Hash Join  (cost=289.00..600.62 rows=1000 width=31) (actual time=5.183..10.242 rows=1000 loops=1)
               Hash Cond: (sessions.movie_id = movies.id)
               ->  Seq Scan on sessions  (cost=0.00..309.00 rows=1000 width=26) (actual time=0.008..4.582 rows=1000 loops=1)
                     Filter: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
                     Rows Removed by Filter: 9000
               ->  Hash  (cost=164.00..164.00 rows=10000 width=21) (actual time=5.157..5.159 rows=10000 loops=1)
                     Buckets: 16384  Batches: 1  Memory Usage: 675kB
                     ->  Seq Scan on movies  (cost=0.00..164.00 rows=10000 width=21) (actual time=0.007..2.121 rows=10000 loops=1)
         ->  Hash  (cost=11.40..11.40 rows=140 width=518) (actual time=0.036..0.036 rows=3 loops=1)
               Buckets: 1024  Batches: 1  Memory Usage: 9kB
               ->  Seq Scan on halls  (cost=0.00..11.40 rows=140 width=518) (actual time=0.021..0.023 rows=3 loops=1)

Planning Time: 1.030 ms
Execution Time: 11.295 ms

(18 rows)
```

После оптимизации:

```postgresql
Sort  (cost=657.85..660.35 rows=1000 width=31) (actual time=8.788..8.881 rows=1000 loops=1)
   Sort Key: sessions.date_start
   Sort Method: quicksort  Memory: 97kB
   ->  Hash Join  (cost=290.07..608.02 rows=1000 width=31) (actual time=3.485..8.431 rows=1000 loops=1)
         Hash Cond: (sessions.hall_id = halls.id)
         ->  Hash Join  (cost=289.00..600.62 rows=1000 width=31) (actual time=3.368..7.947 rows=1000 loops=1)
               Hash Cond: (sessions.movie_id = movies.id)
               ->  Seq Scan on sessions  (cost=0.00..309.00 rows=1000 width=26) (actual time=0.008..4.157 rows=1000 loops=1)
                     Filter: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
                     Rows Removed by Filter: 9000
               ->  Hash  (cost=164.00..164.00 rows=10000 width=21) (actual time=3.343..3.345 rows=10000 loops=1)
                     Buckets: 16384  Batches: 1  Memory Usage: 675kB
                     ->  Seq Scan on movies  (cost=0.00..164.00 rows=10000 width=21) (actual time=0.006..1.440 rows=10000 loops=1)
         ->  Hash  (cost=1.03..1.03 rows=3 width=4) (actual time=0.097..0.097 rows=3 loops=1)
               Buckets: 1024  Batches: 1  Memory Usage: 9kB
               ->  Seq Scan on halls  (cost=0.00..1.03 rows=3 width=4) (actual time=0.011..0.012 rows=3 loops=1)

Planning Time: 1.728 ms
Execution Time: 9.020 ms

(18 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала немного быстрее.

## 100.000 записей

До оптимизации:

```postgresql
Sort  (cost=8532.07..8556.49 rows=9767 width=545) (actual time=54.009..54.467 rows=10000 loops=1)
   Sort Key: sessions.date_start
   Sort Method: quicksort  Memory: 1110kB
   ->  Hash Join  (cost=3219.24..5480.32 rows=9767 width=545) (actual time=27.828..51.634 rows=10000 loops=1)
         Hash Cond: (sessions.hall_id = halls.id)
         ->  Hash Join  (cost=3206.09..5440.76 rows=9767 width=31) (actual time=27.774..49.615 rows=10000 loops=1)
               Hash Cond: (movies.id = sessions.movie_id)
               ->  Seq Scan on movies  (cost=0.00..1637.00 rows=100000 width=21) (actual time=0.004..8.181 rows=100000 loops=1)
               ->  Hash  (cost=3084.00..3084.00 rows=9767 width=26) (actual time=27.723..27.723 rows=10000 loops=1)
                     Buckets: 16384  Batches: 1  Memory Usage: 695kB
                     ->  Seq Scan on sessions  (cost=0.00..3084.00 rows=9767 width=26) (actual time=0.009..24.878 rows=10000 loops=1)
                           Filter: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
                           Rows Removed by Filter: 90000
         ->  Hash  (cost=11.40..11.40 rows=140 width=518) (actual time=0.030..0.031 rows=3 loops=1)
               Buckets: 1024  Batches: 1  Memory Usage: 9kB
               ->  Seq Scan on halls  (cost=0.00..11.40 rows=140 width=518) (actual time=0.020..0.021 rows=3 loops=1)

Planning Time: 1.112 ms
Execution Time: 55.078 ms

(18 rows)
```

После оптимизации:

```postgresql
Sort  (cost=6638.24..6662.66 rows=9767 width=545) (actual time=45.156..45.687 rows=10000 loops=1)
   Sort Key: sessions.date_start
   Sort Method: quicksort  Memory: 1110kB
   ->  Hash Join  (cost=1325.41..3586.49 rows=9767 width=545) (actual time=14.739..42.297 rows=10000 loops=1)
         Hash Cond: (sessions.hall_id = halls.id)
         ->  Hash Join  (cost=1312.26..3546.93 rows=9767 width=31) (actual time=14.554..40.016 rows=10000 loops=1)
               Hash Cond: (movies.id = sessions.movie_id)
               ->  Seq Scan on movies  (cost=0.00..1637.00 rows=100000 width=21) (actual time=0.005..9.085 rows=100000 loops=1)
               ->  Hash  (cost=1190.17..1190.17 rows=9767 width=26) (actual time=14.489..14.491 rows=10000 loops=1)
                     Buckets: 16384  Batches: 1  Memory Usage: 695kB
                     ->  Bitmap Heap Scan on sessions  (cost=136.41..1190.17 rows=9767 width=26) (actual time=1.568..10.767 rows=10000 loops=1)
                           Recheck Cond: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
                           Heap Blocks: exact=834
                           ->  Bitmap Index Scan on idx_sessions_date_start  (cost=0.00..133.97 rows=9767 width=0) (actual time=1.319..1.319 rows=10000 loops=1)
                                 Index Cond: ((date_start >= CURRENT_DATE) AND (date_start <= (CURRENT_DATE + '1 day'::interval)))
         ->  Hash  (cost=11.40..11.40 rows=140 width=518) (actual time=0.120..0.120 rows=3 loops=1)
               Buckets: 1024  Batches: 1  Memory Usage: 9kB
               ->  Seq Scan on halls  (cost=0.00..11.40 rows=140 width=518) (actual time=0.015..0.017 rows=3 loops=1)

Planning Time: 1.974 ms
Execution Time: 46.202 ms

(20 rows)
```

Комментарий:

"Стоимость" запроса уменьшилась, скорость ответа стала немного быстрее.
